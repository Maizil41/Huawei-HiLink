"use strict";"require view";"require poll";const API="/cgi-bin/huawei_hilink";const PoweredBy="Mutiara-Wrt";const E=(tag,attrs,children)=>{const el=document.createElement(tag);if(attrs)
for(const k in attrs){if(k==="class")el.className=attrs[k];else if(k==="style")el.setAttribute("style",attrs[k]);else el.setAttribute(k,attrs[k])}
if(children!=null){if(Array.isArray(children)){children.forEach((c)=>{if(c==null)return;el.append(c.nodeType?c:document.createTextNode(String(c)))})}else{el.append(children?.nodeType?children:document.createTextNode(String(children)))}}
return el};const T=(s)=>(typeof _==="function"?_(s):String(s??""));function num(v){if(v==null)return null;const m=String(v).match(/-?\d+/);return m?parseInt(m[0],10):null}
function clamp(x,a,b){return Math.max(a,Math.min(b,x))}
function pct(v,min,max){const n=num(v);if(n==null)return 0;const p=(n-min)/(max-min);return Math.round(clamp(p,0,1)*100)}
const pctRSSI=(v)=>pct(v,-110,-50);const pctRSRP=(v)=>pct(v,-120,-60);const pctSINR=(v)=>pct(v,-15,30);const pctRSRQ=(v)=>pct(v,-20,-5);const pctRSCP=(v)=>pct(v,-120,-60);const pctECIO=(v)=>pct(v,-20,-3);function qualityPercent(rssi){const n=num(rssi);if(n==null)return 0;const csq=clamp(Math.round((n+113)/2),0,31);return Math.round((csq/31)*100)}
function setBarColored(id,percent,titleText,color){const el=document.getElementById(id);if(!el)return;const p=percent|0;const title=titleText==null||titleText===""?"-":String(titleText);const fill=el.firstElementChild||el.querySelector("div");if(fill){fill.style.width=p+"%";fill.title=title;if(color)fill.style.background=color}
el.title=title}
function colorFromRSSI(v){const n=num(v);if(n==null)return"gray";if(n>-70)return"lime";if(n>=-85)return"yellow";if(n>=-100)return"darkorange";return"red"}
function colorFromRSRP(v){const n=num(v);if(n==null)return"gray";if(n>=-80)return"lime";if(n>=-90)return"yellow";if(n>=-100)return"darkorange";return"red"}
function colorFromSINR(v){const n=num(v);if(n==null)return"gray";if(n>20)return"lime";if(n>=13)return"yellow";if(n>0)return"darkorange";return"red"}
function colorFromRSRQ(v){const n=num(v);if(n==null)return"gray";if(n>=-10)return"lime";if(n>=-15)return"yellow";if(n>=-20)return"darkorange";return"red"}
function colorFromRSCP(v){const n=num(v);if(n==null)return"gray";if(n>=-80)return"lime";if(n>=-90)return"yellow";if(n>=-100)return"darkorange";return"red"}
function colorFromECIO(v){const n=num(v);if(n==null)return"gray";if(n>=-6)return"lime";if(n>=-10)return"yellow";if(n>=-13)return"darkorange";return"red"}
function trSignalImg(id,title,sub){return E("div",{class:"tr"},[E("div",{class:"td left",style:"width:33%"},[T(title),sub?E("div",{style:"text-align:left;font-size:66%"},[T(sub)]):null]),E("div",{class:"td left"},E("span",{id:id+"-wrap"},[E("span",{id:id+"-text",style:"margin-right:6px;"},"0%"),E("img",{id,src:luRes("icons/hilink-0.png"),style:"height:18px",title:"-"})]))])}
function iconFileFromPercent(pct){const p=Math.max(0,Math.min(100,pct|0));if(p===0)return"hilink-0.png";if(p<=20)return"hilink-0-20.png";if(p<=40)return"hilink-20-40.png";if(p<=60)return"hilink-40-60.png";if(p<=80)return"hilink-60-80.png";return"hilink-80-100.png"}
function setSignalImg(id,percent,titleText){const img=document.getElementById(id);const txt=document.getElementById(id+"-text");if(!img||!txt)return;const p=Math.max(0,Math.min(100,percent|0));img.src=luRes("icons/"+iconFileFromPercent(p));txt.textContent=p+"%";img.title=titleText==null||titleText===""?"-":String(titleText)}
async function fetchData(){const r=await fetch(API,{cache:"no-store"});if(!r.ok)throw new Error("HTTP "+r.status);const j=await r.json();if(!j||!j.ok)throw new Error("API error");return j.data||{}}
const MODE_2G=0;const MODE_3G=2;const MODE_4G=7;function computeModeNameRaw(d){if(d&&typeof d.network_mode==="string"&&d.network_mode)return d.network_mode;switch(d?.device_mode){case MODE_4G:return"4G LTE";case MODE_3G:return"3G";case MODE_2G:return"2G";default:return""}}
function computeModeName(d){const raw=(computeModeNameRaw(d)||"").toUpperCase();if(raw.startsWith("4G LTE"))return"4G LTE";if(raw.startsWith("3G"))return"3G";if(raw.startsWith("2G"))return"2G";return""}
const is4G=(d)=>computeModeName(d)==="4G LTE";const is3G=(d)=>computeModeName(d)==="3G";const is2G=(d)=>computeModeName(d)==="2G";function luRes(path){try{return typeof L!=="undefined"&&L.resource?L.resource(path):path}catch(_e){return path}}
function tableRows(rows){return E("div",{class:"table"},rows)}
function trProgress(id,title,sub){return E("div",{class:"tr"},[E("div",{class:"td left",style:"width:33%"},[T(title),sub!=null&&sub!==""?E("div",{style:"text-align:left;font-size:66%"},[T(sub)]):null]),E("div",{class:"td"},E("div",{id,class:"cbi-progressbar",title:"-"},E("div"))),])}
function trKVLeft(k,v){function asChild(x){if(x==null)return T("");if(typeof x==="string"||typeof x==="number")return T(String(x));if(Array.isArray(x))return x;return x}
return E("div",{class:"tr"},[E("div",{class:"td left",style:"width:33%"},T(k)),E("div",{class:"td left"},asChild(v)),])}
function renderConnStat(d){const el=document.getElementById("connst");if(!el)return;const wicon=luRes("icons/loading.gif");const ticon=luRes("icons/ctime.png");const hasSig=d&&d.rssi!=null&&d.rssi!==""&&d.rssi!=="-";if(!hasSig){el.textContent="-";return}
if(d.connt==null||d.connt===""||d.connt==="-"){el.innerHTML=`<img style="width:16px;height:16px;vertical-align:middle;" src="${wicon}"/> `+T("Waiting for connection data...");return}
const rx=d.connrx!=null&&d.connrx!==""?d.connrx:"-";const tx=d.conntx!=null&&d.conntx!==""?d.conntx:"-";el.innerHTML=`<img style="width:16px;height:16px;vertical-align:middle;" src="${ticon}"/> `+`${d.connt} | \u25bc\u202f${rx} \u25b2\u202f${tx}`}
const EMPTY_DATA={operator:"-",plmn:"-",network_mode:"-",device_mode:null,rssi:"-",rsrp:"-",sinr:"-",rsrq:"-",rscp:"-",ecio:"-",lac_dec:"-",lac_hex:"-",cell_id_dec:"-",cell_id_hex:"-",enb_rnc:"-",cell_index:"-",earfcn_dl:"-",earfcn_ul:"-",bandwidth_dl_mhz:"-",bandwidth_ul_mhz:"-",band:"-",pci:"-",connt:"-",connrx:"-",conntx:"-"};function renderAll(d,$top,$sig,$cell){const modeName=computeModeName(d);const scorePct=qualityPercent(d.rssi);$top.innerHTML="";$top.append(E("h3",{},T("General Information")),E("div",{class:"table"},[trSignalImg("sigimg","Signal strength",""),trKVLeft("Operator",d.operator||""),trKVLeft("PLMN",d.plmn||""),trKVLeft("Technology",modeName||""),trKVLeft("Connection statistics",E("span",{id:"connst"},"-")),]));setSignalImg("sigimg",scorePct,scorePct+"%");$sig.innerHTML="";const modeTitle=(modeName==="4G LTE"||modeName==="3G")?"Signal Information":"Signal";$sig.append(E("h3",{},T(modeTitle)));if(is4G(d)){$sig.append(tableRows([trKVLeft("Band",d.band||""),trKVLeft("PCI",d.pci||""),trKVLeft("EARFCN (DL/UL)",(d.earfcn_dl||"")+(d.earfcn_ul?" / "+d.earfcn_ul:"")),trKVLeft("Bandwidth (MHz) DL/UL",(d.bandwidth_dl_mhz!=null?d.bandwidth_dl_mhz:"")+(d.bandwidth_ul_mhz!=null?" / "+d.bandwidth_ul_mhz:""))]))}
const sigRows=[];sigRows.push(trProgress("rssin","RSSI","(Received Signal Strength Indicator)"));if(is4G(d)){sigRows.push(trProgress("rsrpn","RSRP","(Reference Signal Receive Power)"));sigRows.push(trProgress("sinrn","SINR","(Signal to Interference plus Noise Ratio)"));sigRows.push(trProgress("rsrqn","RSRQ","(Reference Signal Received Quality)"))}else if(is3G(d)){sigRows.push(trProgress("rscpn","RSCP","(Received Signal Code Power)"));sigRows.push(trProgress("ecion","Ec/Io","(Energy per chip / Interference)"))}
$sig.append(tableRows(sigRows));setBarColored("rssin",pctRSSI(d.rssi),d.rssi||"-",colorFromRSSI(d.rssi));if(is4G(d)){setBarColored("rsrpn",pctRSRP(d.rsrp),d.rsrp||"-",colorFromRSRP(d.rsrp));setBarColored("sinrn",pctSINR(d.sinr),d.sinr||"-",colorFromSINR(d.sinr));setBarColored("rsrqn",pctRSRQ(d.rsrq),d.rsrq||"-",colorFromRSRQ(d.rsrq))}else if(is3G(d)){setBarColored("rscpn",pctRSCP(d.rscp),d.rscp||"-",colorFromRSCP(d.rscp));setBarColored("ecion",pctECIO(d.ecio),d.ecio||"-",colorFromECIO(d.ecio))}
$cell.innerHTML="";const cellRows=[];if(is4G(d)){cellRows.push(trKVLeft("TAC (dec)",d.lac_dec));cellRows.push(trKVLeft("TAC (hex)",d.lac_hex));cellRows.push(trKVLeft("ECellID (dec)",d.cell_id_dec));cellRows.push(trKVLeft("ECellID (hex)",d.cell_id_hex));cellRows.push(trKVLeft("eNB / Cell",d.enb_rnc!=null&&d.cell_index!=null?d.enb_rnc+" / "+d.cell_index:""))}else if(is3G(d)){cellRows.push(trKVLeft("LAC (dec)",d.lac_dec));cellRows.push(trKVLeft("LAC (hex)",d.lac_hex));cellRows.push(trKVLeft("Cell ID (dec)",d.cell_id_dec));cellRows.push(trKVLeft("Cell ID (hex)",d.cell_id_hex));cellRows.push(trKVLeft("RNC / CI",d.enb_rnc!=null&&d.cell_index!=null?d.enb_rnc+" / "+d.cell_index:""))}else{cellRows.push(trKVLeft("LAC (dec)",d.lac_dec));cellRows.push(trKVLeft("LAC (hex)",d.lac_hex));cellRows.push(trKVLeft("Cell ID (dec)",d.cell_id_dec));cellRows.push(trKVLeft("Cell ID (hex)",d.cell_id_hex))}
$cell.append(E("h3",{},T("Cell Information")),tableRows(cellRows));renderConnStat(d)}
async function repaint($top,$sig,$cell,$alert){try{const d=await fetchData();$alert.style.display="none";renderAll(d,$top,$sig,$cell)}catch(e){$alert.style.display=""}}
return view.extend({load:function(){return Promise.resolve()},render:function(){const root=E("div",{class:"cbi-map"},[E("div",{id:"hw-alert",class:"alert-message warning",style:"display:none"},T("Failed fetch data from API.")),E("div",{id:"card-top",class:"cbi-section"}),E("div",{id:"card-sig",class:"cbi-section"}),E("div",{id:"card-cell",class:"cbi-section"}),]);const $alert=root.querySelector("#hw-alert");const $top=root.querySelector("#card-top");const $sig=root.querySelector("#card-sig");const $cell=root.querySelector("#card-cell");renderAll(EMPTY_DATA,$top,$sig,$cell);repaint($top,$sig,$cell,$alert);poll.add(()=>repaint($top,$sig,$cell,$alert),3);return root},handleSaveApply:null,handleReset:null,handleSave:null,})
